#!/bin/sh

. /lib/dracut-lib

getarg rdnetdebug && {
    exec >/tmp/netroot.$1.$$.out
    exec 2>>/tmp/netroot.$1.$$.out
    set -x
}

# Only try to configure from one network interface at a time
#
[ "$NETROOT_LOCKED" ] || {
    NETROOT_LOCKED=true
    export NETROOT_LOCKED
    exec flock -xo /tmp/netroot.lock -c "$0 $*"
    exit 1
}

netif=$1

# If we've already found a root, or we don't have the info we need,
# then no point in looking further
#
[ -e /tmp/netroot.done ] && exit 0
[ -s /tmp/netroot.info -a -s /tmp/root.info ] || exit 0

# Pick up our config from the command line; we may already know the
# handler to run
#
. /tmp/root.info
. /tmp/netroot.info
[ -e /tmp/dhclient.$netif.dhcpopts ] && . /tmp/dhclient.$netif.dhcpopts

# Now, let the installed network root handlers figure this out
#
source_all netroot

# If we didn't get a handler set, then we're done
#
if [ -z "$handler" ]; then
    # XXX informative error message?
    exit 0
fi

# Run the handler; don't store the root, it may change from device to device
# XXX other variables to export?
export NEWROOT
if $handler $netif $root; then
    # Network rootfs mount successful
    [ -f /tmp/dhclient.$netif.lease ] &&    cp /tmp/dhclient.$netif.lease    /tmp/net.$netif.lease
    [ -f /tmp/dhclient.$netif.dhcpopts ] && cp /tmp/dhclient.$netif.dhcpopts /tmp/net.$netif.dhcpopts
    cat /sys/class/net/eth0/address > /tmp/net.$netif.hwaddr
    echo "# Generated by dracut initrd" > /tmp/net.$netif.ifcfg
    echo "DEVICE=$netif" >> /tmp/net.$netif.ifcfg
    echo "HWADDR=$(cat /sys/class/net/eth0/address)" >> /tmp/net.$netif.ifcfg
    echo "TYPE=Ethernet" >> /tmp/net.$netif.ifcfg
    echo "ONBOOT=yes" >> /tmp/net.$netif.ifcfg
    if [ -f /tmp/net.$netif.lease ]; then
        echo "BOOTPROTO=dhcp" >> /tmp/net.$netif.ifcfg
    else
        echo "BOOTPROTO=none" >> /tmp/net.$netif.ifcfg
        # Static: XXX Implement me!
        #IPADDR=172.16.101.1
        #NETMASK=255.255.255.0
        #DNS1=1.2.3.4
        #DNS2=1.2.3.5
        #GATEWAY=172.16.101.254
    fi
    >/tmp/netroot.done
fi
exit 0
