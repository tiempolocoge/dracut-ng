#!/bin/bash
. ./dracut-functions
readonly initdir=$(mktemp -d -t initramfs-test-XXXXXXXX)
readonly mnttarget=$(mktemp -d -t initramfs-test-target-XXXXXXXX)
trap 'rm -rf "$initdir"' 0
dracut_install sh df free ls shutdown poweroff stty cat ps ln \
    /lib/terminfo/l/linux mount dmesg
inst test/test-init /sbin/init
dd if=/dev/zero of=test/root.ext2 bs=1M count=10
mke2fs -F test/root.ext2
mount -o loop -t ext2 test/root.ext2 "$mnttarget"
cp -a -t "$mnttarget" "$initdir"/*
(cd "$mnttarget"; mkdir -p dev sys proc etc)
umount -l "$mnttarget"
rm -rf "$mnttarget" "$initdir"